# テストラボシステム拡張ガイド

## 目的

テストラボシステムの拡張方法について、検討する項目を示す。

## コンテナフォーマットを取り扱うシステムの構成

環境構築で示したように、テストラボシステムは、以下のような構成となっている。
![](./overview.drawio.png)

コンテナフォーマットを取り扱うシステムの検証のためには以下の検討事項がある

### 必要な機能

「コンテナ処理データ蓄積」機能を軸に見るとコンテナフォーマットを処理するとは以下である。
1. コンテナデータ（センサ等のデータ）を入力とする
2. スキーマリポジトリを参照しコンテナデータに対応するスキーマファイルを使う
3. コンテナを処理した結果を外部に出力する

上記の３機能を持つアプリケーションを接続することでテストラボシステムを拡張することができる

### センサーとシステムの接続

センサーとテストラボシステムは同じネットワークにいない場合がある。  
そのため、センサーとテストラボシステムを接続するためどのように接続するかについては検討が必要である。

### コンテナフォーマットの作成

センサデータのコンテナフォーマット化をどこかで行う必要がある。
コンテナフォーマット化をどこで行うかについては検討が必要である。


###

### Data ID



## チュートリアルでの構成例

チュートリアルでの構成について、コンテナ処理データ蓄積部分を詳細化すると以下のような構成要素を持っている。

![](./detail.drawio.png)


テストラボシステムの構成要素について、以降に詳細を記述する。

### kafka
kafka はデータ構造に依存しないメッセージキューである。。
トピックと呼ばれる単位でキューを構成し、キューに対してデータを提供する処理と、キューからデータを取得する処理が存在する。
kafkaとは、このようなキューを提供するためのミドルウェアである。

### WebApp
WebAppはセンサデータを取得し、センサデータを格納したコンテナデータをhttp経由によって収集し、kafkaに投入するアプリである。  
コンテナデータはkafkaのキューに格納され、次の処理へ引き渡される。

### container-consumer
container-consumerはkafkaのキューからコンテナデータを取得し、処理するアプリである。
コンテナデータを解析して、対応するスキーマファイルをスキーマリポジトリから取得する。
スキーマファイルを利用して、コンテナデータを処理し利用しやすいフォーマットに変換し、kafkaに投入する。

### スキーマリポジトリ
コンテナに格納されたデータのスキーマを管理するリポジトリである。
スキーマファイルの定義をしておくことで、コンテナデータに対応するスキーマデータを配賦できる。

### KSQL
kafka のキューにあるデータに対して、Streaming SQLと呼ばれるストリームデータにSQLライクなクエリを利用可能にする仕組みである

kafkaのキューに格納されたデータをSQLライクなクエリで処理することができる。
処理方法の定義例は [環境構築手順](./environment#%E3%83%87%E3%83%BC%E3%82%BF%E5%A4%89%E6%8F%9B%E3%81%AE%E7%99%BB%E9%8C%B2) であり、
kafkaのキューに入るデータをストリーミングテーブルとして定義することや、ストリーミングテーブルのデータをkafkaのキューとして出力することができる。

ここでは、JSONのデータをAVROと呼ばれるデータフォーマットに書き換えることと、サーバでのタイムスタンプの付与を行う。

### JDBC Connector  
kafkaのキューにAVRO形式で蓄積したデータをRDBに蓄積するための仕組みである。
