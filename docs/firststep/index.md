# 動作手順

## データを送信するアプリケーション

構築手順の最後で ngrok を用いて公開した URL をスマートフォンから開きます。

開くと以下の画面が表示されます。

![](./toppage.png)

### Web アプリケーションでのセンサ情報の取得

画面下部の **モーションの許可** を押下するとダイアログが表示されます。  
※iPhone の場合

![](allow_dialog.png)

"動作と方向"へのアクセスを許可することで、
画面内の値が目まぐるしく変わるようになり、
ジャイロセンサーの情報をコンテナに利用できます。

### データの送信について

このアプリには以下の設定項目があります。

- データの送信頻度＆センサからの取得頻度
- 送信データのフォーマット選択
- データを送信の有効化

それぞれの設定項目に対して、

- 送信間隔をデフォルト値の `1000 msec` から `50 msec` に変更
- 送信するデータを `container` とする(デフォルト値)
- `定期送信` にチェックを入れる

これによってコンテナの形でデータが送信されるようになります。

### 可視化データの確認

このアプリから送られるコンテナについては必要なスキーマ情報や処理が登録されているので、
可視化されたデータを見に行きます。

[http://localhost:3000/](http://localhost:3000/) からリンクをたどって ExampleDashboard を開いてください。
![](testlab_preview.png)

ここまででテストラボのチュートリアルは終了です。

## スマートフォンセンサ機能でのコンテナデータの可視化

このアプリには、送信に用いるコンテナデータを可視化して表示しています。

![](./toppage_anno.png)

画像内赤枠の Container 部分は、実際に送信されるコンテナの Hex 表記されたものです。
`type:`, `length:` 等は可読性のために記述しているもので、 `:` より右側の hex 値だけがコンテナデータです。

アプリ上 `モーションの許可` をした後に、画面上の表示の変化のありなしを観測すると理解しやすいですが、
ヘッダ部分である `type:`, `length:` にあたるデータは固定的なヘッダとなります。

:::caution
ここで作られているコンテナは[Container Format で示された仕様](spec_guide)と差異がある。

- Data ID Length フィールドがない。
  :::

対して、Payload はセンサーの計測値を反映するため値が高頻度で更新されます。  
ペイロードは以下のような形式で送信されます。

![](./payload_example.png)

７つのフィールドがありますが、詳細は以下です。

| 名称      | 型           | データ幅 | 詳細                          |
| --------- | ------------ | -------- | :---------------------------- |
| timestamp | 符号なし整数 | 8        | 1970/01/01 からの経過ミリ秒数 |
| acce x    | 浮動小数     | 8        | 加速度センサーの x 軸方向の値 |
| acce y    | 浮動小数     | 8        | 加速度センサーの y 軸方向の値 |
| acce z    | 浮動小数     | 8        | 加速度センサーの z 軸方向の値 |
| alpha     | 浮動小数     | 8        | 傾きセンサーの x 軸方向の値   |
| beta      | 浮動小数     | 8        | 傾きセンサーの y 軸方向の値   |
| gamma     | 浮動小数     | 8        | 傾きセンサーの z 軸方向の値   |

:::note
加速度やジャイロの値については、
[MDN の方向および動きとして示されるデータ](https://developer.mozilla.org/ja/docs/Web/API/Device_orientation_events/Orientation_and_motion_data_explained)
でより詳細な情報が記述されています。
:::

### コンテナデータの例でわかること

コンテナデータは以下の要素で構成される。

- 固定的なコンテナヘッダ
- センサの生み出すデータ

この複数の要素を結合したもの、これがコンテナフォーマットによるコンテナデータの一つの例になります。

## スキーマファイルの確認と編集

### スキーマファイルの確認方法

スキーマファイルの設定画面から上記のコンテナに対応するスキーマデータとスキーマデータに対応するデータを確認します。

環境構築でも利用した[Download(ExampleContainer)](mobile_acce.cntr)ファイルが今回のコンテナデータの例と同じ構造です。

読み込むことでコンテナデータに対応するスキーマファイルをサーバから呼び出し、読み込んだコンテナに適用して表示することができます。
スキーマファイルはこの画面から更新する事もできます。（画面上部 save ボタンでスキーマ編集結果を保存）

[http://localhost:30002/](http://localhost:30002/)

画面左が、コンテナデータのバイナリを Hex 記法(16 進数)で表示した領域です。
画面右が、コンテナデータに対応するスキーマファイルの内容表示およびスキーマの編集を行う領域です。

![](iot-repository-example.png)

### スキーマファイルの編集方法

画面右の Configuration と Tags の列が設定可能な項目です。
１行が１つのフィールドを指し、フィールドは何らかの情報一つに対応します。

#### Configuration

以下の３つの要素を設定できます

- Name フィールドの名前
- Position Payload の開始位置からのオフセット値
- Type/Length オフセット位置からのデータ幅とデータ型

この３つによって、スキーマのフィールドの範囲が定される。
データ型は符号なし整数、符号あり整数、浮動小数点数、バイト列の４つから選択できる。
データ幅はデータ型によって決まる場合は自動設定され、決まらない場合は自由入力ができる。

#### Tags

<!-- プロパティ -->

フィールドに対して付加的な情報を記述することができます。

test-lab-system の実装では、フィールドのタグに `isLittleEndian` があれば、複数バイトで構成される値をリトルエンディアンで解釈します。

実装次第でエンディアンや値の意味が異なるため Tags で付加的情報を定義することで、
スキーマの情報を元にコンテナを処理することができる。

#### add new field

スキーマファイルに新しいフィールドを足します。
フィールドは直前の例でいうと `timestamp` や `acce X` に対応します。

## まとめ

このページのまとめです。

- 事前準備されサンプルアプリでコンテナを送信した
- コンテナによって収集したデータが可視化できることを確認した。
- コンテナの形式について例を確認した
- スキーマについて定義の例を確認した
- スキーマについて定義の例を確認した
